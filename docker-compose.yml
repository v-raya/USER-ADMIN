version: '3.2'
services:
  perry:
    image: cwds/perry
    hostname: perry
    depends_on:
          - cals_db2_data
          - postgresql_data
    restart: on-failure
    ports:
          - 18080:8080
          - 18081:8090
    environment:
      DEV_MODE: ${DEV_MODE}
      COGNITO_MODE: ${COGNITO_MODE}
      SAF_CLIENT_ID: ${SAF_CLIENT_ID}
      SAF_CLIENT_SECRET: ${SAF_CLIENT_SECRET}
      SAF_RETRIEVE_TOKEN_PATH: ${SAF_RETRIEVE_TOKEN_PATH}
      SAF_AUTH_PATH: ${SAF_AUTH_PATH}
      SAF_REVOKE_TOKEN_URI: ${SAF_REVOKE_TOKEN_URI}
      SAF_USER_INFO_URI: ${SAF_USER_INFO_URI}
      SAF_VALIDATE_TOKEN_URI: ${SAF_VALIDATE_TOKEN_URI}
      SAF_LOGOUT_URI: ${SAF_LOGOUT_URI}
      SAF_REVOKE_TOKEN_URI: ${SAF_REVOKE_TOKEN_URI}
      DB_CMS_DB2_HOST: ${DB_CMS_DB2_HOST}
      DB_CMS_DB2_PORT: ${DB_CMS_DB2_PORT}
      DB_CMS_JDBC_URL: ${DB_CMS_JDBC_URL}
      DB_CMS_SCHEMA: ${DB_CMS_SCHEMA}
      DB_POSTGRES_PORT: ${DB_POSTGRES_PORT}
      TOKEN_STORE_JDBC_URL: ${TOKEN_STORE_JDBC_URL}
      TOKEN_STORE_DB_USER: ${TOKEN_STORE_DB_USER}
      TOKEN_STORE_DB_PASSWORD: ${TOKEN_STORE_DB_PASSWORD}
      COGNITO_IAM_ACCESS_ID: ${COGNITO_IAM_ACCESS_ID}
      COGNITO_IAM_SECRET: ${COGNITO_IAM_SECRET}
      COGNITO_REGION: {COGNITO_REGION}
      COGNITO_USERPOOL: ${COGNITO_USERPOOL}
  cals_db2_data:
    image: cwds/db2data
    hostname: cals_db2_data
    ports:
      - ${DB_CMS_DB2_PORT}:50000
  postgresql_data:
    image: cwds/postgresql_data
    hostname: postgresql_data
    ports:
      - ${DB_POSTGRES_PORT}:${DB_POSTGRES_PORT}
  county-admin-web:
    build:
      context: .
      dockerfile: docker/web/Dockerfile
    volumes:
      - type: bind
        source: ./app
        target: /app/app
    ports:
      - ${COUNTY_ADMIN_APP_PORT}:3000
      - ${COUNTY_ADMIN_APP_WEBPACK_PORT}:3035
    environment:
      SECRET_KEY_BASE: ${SECRET_KEY_BASE}
      COUNTY_ADMIN_APP_JS_API_URL: ${COUNTY_ADMIN_APP_JS_API_URL}
      PERRY_API_BASE_URL: "http://${DEV_IP}:${PERRY_PORT}/perry"
      AUTHENTICATION: ${AUTHENTICATION}
      COUNTY_ADMIN_WEB_BASE_URL: ${COUNTY_ADMIN_WEB_BASE_URL}
      DASHBOARD_URL: ${DASHBOARD_URL}
      RAILS_RELATIVE_URL_ROOT: ${RAILS_RELATIVE_URL_ROOT}
    command: ['bundle', 'exec', 'rails', 'server']
    depends_on:
      - perry
  county-admin-test:
    build:
      context: .
      dockerfile: docker/test/Dockerfile
    volumes:
      - type: bind
        source: ./spec
        target: /app/spec
    environment:
      - SECRET_KEY_BASE
      - PERRY_API_BASE_URL
      - COUNTY_ADMIN_WEB_BASE_URL
      - DASHBOARD_URL
      - RAILS_RELATIVE_URL_ROOT
